<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8" />
    <title>åœ°åœ–é€£ç·šåœ–æ¸¬è©¦ - Vis.js</title>
    <script type="text/javascript" src="https://unpkg.com/vis-network@9.1.2/dist/vis-network.min.js"></script>
    <link href="https://unpkg.com/vis-network@9.1.2/dist/vis-network.min.css" rel="stylesheet" type="text/css" />
    
    <style>
        /* è¨­ç½®å®¹å™¨å¤§å°ï¼Œé€™æ˜¯ Vis.js æ¸²æŸ“çš„å¿…è¦æ¢ä»¶ */
        #network-map-container {
            width: 95%;
            height: 800px; /* è¨­ç½®ä¸€å€‹è¶³å¤ çš„é«˜åº¦ */
            border: 1px solid #ccc;
            margin: 20px auto;
            background: #f9f9f9;
        }

        /* ------------------ Modal æ¨£å¼ (å»¶ç”¨æ‚¨åŸæœ‰çš„çµæ§‹) ------------------ */
        #modalOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); z-index: 9998; display: none; }
        #modalBox { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 10px; z-index: 9999; max-width: 600px; width: 90%; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5); display: none; color: #333; }
        #modalBox .close-btn { position: absolute; top: 10px; right: 20px; font-size: 30px; cursor: pointer; color: #aaa; }
        
        .hero-column-details { display: flex; gap: 20px; align-items: flex-start; margin-top: 15px; }
        .hero-image { max-width: 50%; height: auto; object-fit: contain; border-radius: 8px; }
        .hero-name { color: #333; margin-top: 0; padding-bottom: 10px; border-bottom: 1px solid #eee; }
        .section-gap { margin-top: 10px; }
    </style>
</head>
<body>
    <h2 style="text-align: center;">éŠæˆ²å€åŸŸé€£ç·šåœ– (Vis.js äº’å‹•æ¸¬è©¦)</h2>
    <p style="text-align: center; color: #666;">å¯æ‹–æ›³ç¯€é»ã€æ»¾è¼ªç¸®æ”¾ã€‚é»æ“Šç¯€é»æŸ¥çœ‹è©³ç´°è³‡æ–™ã€‚</p>

    <div id="network-map-container"></div>
    
    <div id="modalOverlay"></div>
    <div id="modalBox">
        <span class="close-btn">&times;</span>
        <div id="modalContent">
            </div>
    </div>

    <script>
        let mapData = []; // å„²å­˜è©³ç´°è³‡æ–™ (ä¾‹å¦‚æ‰è½ç‰©)

        document.addEventListener("DOMContentLoaded", () => {
            // === è¼‰å…¥æ‰€æœ‰åœ°åœ–è©³ç´°è³‡æ–™ (Modal å…§å®¹) ===
            const detailDataPromise = fetch("/mo_data/data/detailed_maptest.json")
                .then(res => {
                    if (!res.ok) throw new Error("è¼‰å…¥ detailed_maptest.json å¤±æ•—");
                    return res.json();
                })
                .then(json => {
                    mapData = Array.isArray(json) ? json : json.data;
                    console.log("âœ… åœ°é»è©³ç´°è³‡æ–™è¼‰å…¥å®Œæˆ:", mapData.length, "ç­†");
                })
                .catch(err => {
                    console.error("âŒ è©³ç´°è³‡æ–™ JSON è¼‰å…¥å¤±æ•—ï¼š", err);
                });

            // === è¼‰å…¥é€£ç·šåœ–è³‡æ–™ (Nodes & Edges) ===
            const graphDataPromise = fetch("/mo_data/data/graph_data.json")
                .then(res => {
                    if (!res.ok) throw new Error("è¼‰å…¥ graph_data.json å¤±æ•—");
                    return res.json();
                })
                .catch(err => {
                    console.error("âŒ åœ–å½¢è³‡æ–™ JSON è¼‰å…¥å¤±æ•—ï¼š", err);
                    return { nodes: [], edges: [] };
                });

            // === ç­‰å¾…å…©çµ„è³‡æ–™éƒ½è¼‰å…¥å®Œæˆå¾Œï¼Œåˆå§‹åŒ–åœ°åœ– ===
            Promise.all([detailDataPromise, graphDataPromise]).then(([_, graphJson]) => {
                if (graphJson.nodes && graphJson.nodes.length > 0) {
                    initNetworkMap(graphJson.nodes, graphJson.edges);
                } else {
                    document.getElementById('network-map-container').innerHTML = "<p style='text-align:center;'>åœ–å½¢è³‡æ–™è¼‰å…¥å¤±æ•—æˆ–ç‚ºç©ºã€‚</p>";
                }
            });
            
            // === Modal é—œé–‰é‚è¼¯ (å»¶ç”¨) ===
            const closeModal = () => {
                document.getElementById("modalOverlay").style.display = "none";
                document.getElementById("modalBox").style.display = "none";
            };
            const closeBtn = document.querySelector("#modalBox .close-btn");
            if (closeBtn) closeBtn.addEventListener("click", closeModal);
            document.getElementById("modalOverlay").addEventListener("click", closeModal);
        });

        // ----------------------------------------------------
        // ğŸ“Œ Vis.js æ ¸å¿ƒåˆå§‹åŒ–å‡½æ•¸
        // ----------------------------------------------------
        function initNetworkMap(nodesData, edgesData) {
            const container = document.getElementById('network-map-container');
            
            // 1. è½‰æ›æ•¸æ“šæ ¼å¼
            const nodes = new vis.DataSet(nodesData);
            const edges = new vis.DataSet(edgesData);
            const data = { nodes: nodes, edges: edges };

            // 2. é…ç½®é¸é …
            const options = {
                // è¨­å®šä½ˆå±€ç‚ºå±¤æ¬¡çµæ§‹ (åƒæ‚¨çš„åœ°åœ–ä¸€æ¨£çš„æ¨¹ç‹€åœ–)
                layout: {
                    // ä½¿ç”¨é è¨­çš„å±¤æ¬¡ä½ˆå±€
                    hierarchical: {
                        direction: 'UD', // ä¸Šåˆ°ä¸‹ (Up-Down)
                        sortMethod: 'directed', // ä¿æŒç®­é ­æ–¹å‘
                        levelSeparation: 80, // å±¤ç´šé–“è·
                        nodeSpacing: 100 // ç¯€é»é–“è·
                    }
                },
                // ç¯€é»æ¨£å¼
                nodes: {
                    shape: 'box', // æ–¹å¡Šå½¢ç‹€
                    size: 20,
                    font: { size: 14, color: '#333' },
                    margin: 10
                },
                // é‚Šç·£æ¨£å¼ (é€£ç·š)
                edges: {
                    width: 2,
                    smooth: {
                        type: 'cubicBezier'
                    }
                },
                // äº¤äº’è¡Œç‚ºï¼šå•Ÿç”¨ç¸®æ”¾ã€æ‹–æ›³ã€é»æ“Š
                interaction: {
                    zoomView: true,
                    dragView: true,
                    selectNodesOnDrag: false,
                    hover: true
                },
                // ç‰©ç†æ¨¡æ“¬ (è®“ç¯€é»è‡ªå‹•æ’åˆ—çš„åŠŸèƒ½)
                physics: {
                    enabled: true,
                    // ç”±æ–¼æˆ‘å€‘ä½¿ç”¨äº† hierarchical ä½ˆå±€ï¼Œå¯ä»¥ç¦ç”¨æˆ–å¾®èª¿ç‰©ç†æ•ˆæœ
                    solver: 'hierarchicalRepulsion' 
                }
            };

            // 3. å‰µå»ºç¶²è·¯åœ–å¯¦ä¾‹
            const network = new vis.Network(container, data, options);

            // 4. ç¶å®šé»æ“Šäº‹ä»¶
            network.on("click", function (params) {
                // ç¢ºä¿é»æ“Šçš„æ˜¯ä¸€å€‹ç¯€é» (Node)
                if (params.nodes.length > 0) {
                    const nodeId = params.nodes[0];
                    
                    // æ ¹æ“šç¯€é» ID æŸ¥æ‰¾è©³ç´°è³‡æ–™ (å¾ mapData ä¸­)
                    const item = mapData.find(i => i.mapid === nodeId); 
                    
                    if (item) {
                        showDetailModal(item);
                    } else {
                        // é€™æ˜¯å€‹ç¯€é»ï¼Œä½† detailed_maptest.json ä¸­æ²’æœ‰å®ƒçš„è³‡æ–™
                        console.warn(`ç¯€é» "${nodeId}" ç„¡å°æ‡‰çš„è©³ç´°è³‡æ–™ã€‚`);
                        alert(`ç¯€é» "${nodeId}" å°šç„¡è©³ç´°è³‡æ–™ã€‚`);
                    }
                }
            });
        }
        
        // ----------------------------------------------------
        // ğŸ“Œ Modal é¡¯ç¤ºå‡½æ•¸ (å»¶ç”¨æ‚¨åŸæœ‰çš„é‚è¼¯)
        // ----------------------------------------------------
        async function showDetailModal(item) {
            const overlay = document.getElementById("modalOverlay");
            const modalBox = document.getElementById("modalBox");
            const contentDiv = document.getElementById("modalContent");

            const img = new Image();
            img.alt = item.mapid;
            img.className = "hero-image";
            img.style.width = "auto";
            img.style.height = "auto";
            img.style.objectFit = "contain";

            const path = `/mo_data/pic/map/${item.mapid}.jpg`;

            try {
                await new Promise((resolve, reject) => {
                    img.onload = resolve;
                    img.onerror = reject;
                    img.src = path;
                });
            } catch {
                console.warn(`åœ–ç‰‡è¼‰å…¥å¤±æ•— (${path})ï¼Œä½¿ç”¨é è¨­åœ–`);
                img.src = "/mo_data/pic/default.png";
            }

            const html = `
                <h2 class="hero-name">${item.mapid}</h2>
                <div class="hero-column-details">
                    <div style="flex:1;"></div> 
                    <div style="flex:1;">
                         <p><strong>ç­‰ç´šï¼š</strong>${item.maplv || 'N/A'}</p>
                         <p><strong>åƒåœ¾æ‰è½ï¼š</strong>${item.drop_rubbish || 'N/A'}</p>
                         <p class="section-gap"><strong>å…‰è¼æ‰è½(æ‰è½è¼ƒå¤š)ï¼š</strong><span>${item.drop_glory_high || 'N/A'}</span></p>
                         <p class="section-gap"><strong>å…‰è¼æ‰è½(æ‰è½è¼ƒä½)ï¼š</strong><span>${item.drop_glory_low || 'N/A'}</span></p>
                         <p class="section-gap"><strong>å…‰è¼æ‰è½(ç©å®¶æä¾›)ï¼š</strong>-</p>
                    </div>
                </div>
            `;
            
            contentDiv.innerHTML = html;
            
            const imgContainer = contentDiv.querySelector(".hero-column-details > div:first-child");
            if(imgContainer) {
                 imgContainer.appendChild(img);
            }

            overlay.style.display = "block";
            modalBox.style.display = "block";
        }
    </script>
</body>
</html>